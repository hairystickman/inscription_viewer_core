"use strict";!function(){window.console=window.console||{},window.console.assert=window.console.assert||function(){},window.console.error=window.console.error||function(){};var e=function(e){var i=this;this.images=e.images,this.startingZoom=e.zoom,this.startingPan=e.pan,this.isMobile=void 0!==window.orientation||-1!==navigator.userAgent.indexOf("IEMobile"),this.isMobile?(this.clipFactorX=.5,this.clipFactorY=.5):(this.clipFactorX=0,this.clipFactorY=0),OpenSeadragon.EventSource.call(this);var t=e.osdOptions;t.element=e.container,this.viewer=OpenSeadragon(t),this.viewer.canvas.style.outline="none",this.tracker=new OpenSeadragon.MouseTracker({element:this.viewer.canvas,moveHandler:function(e){i.isMobile||i.dragClip(e.position,!0,!0)},pressHandler:function(e){if(i.isMobile){var t=i.getShownImages();if(!(t.length<=1)){var n=new OpenSeadragon.Point(i.viewer.container.clientWidth*i.clipFactorX,i.viewer.container.clientHeight*i.clipFactorY);2===t.length?Math.abs(n.x-e.position.x)<20&&(i.isDraggingClipX=!0):3===t.length&&(Math.abs(n.x-e.position.x)<20&&e.position.y<n.y+20&&(i.isDraggingClipX=!0),Math.abs(n.y-e.position.y)<20&&(i.isDraggingClipY=!0))}}},releaseHandler:function(e){i.isDraggingClipX=!1,i.isDraggingClipY=!1}}),this.viewer.addHandler("viewport-change",function(){i.updateClip(),i.raiseEvent("change:viewport")}),this.viewer.addHandler("add-item-failed",function(e){i.raiseEvent("add-item-failed",e)}),this.viewer.addHandler("canvas-drag",function(e){(i.isDraggingClipX||i.isDraggingClipY)&&(e.preventDefaultAction=!0,i.dragClip(e.position,i.isDraggingClipX,i.isDraggingClipY))}),this.images.forEach(function(e,t){e.curtain={},i.viewer.addTiledImage({tileSource:e.tileSource,opacity:e.shown,success:function(n){e.curtain.tiledImage=n.item,e.curtain.tiledImage.setOpacity(e.shown?1:0),0===t&&(i.startingZoom&&i.viewer.viewport.zoomTo(i.startingZoom,null,!0),i.startingPan&&i.viewer.viewport.panTo(i.startingPan,!0)),i.updateClip()}})})};e.prototype=OpenSeadragon.extend({destroy:function(){this.images.forEach(function(e){delete e.curtain}),this.tracker.destroy(),this.viewer.destroy()},getZoom:function(){return this.viewer.viewport.getZoom()},setZoom:function(e){this.viewer.viewport.zoomTo(e,null,!0),this.startingZoom=e},getPan:function(){return this.viewer.viewport.getCenter()},setPan:function(e){this.viewer.viewport.panTo(e,!0),this.startingPan=e},zoomIn:function(){this.viewer.viewport.zoomBy(this.viewer.zoomPerClick),this.viewer.viewport.applyConstraints()},zoomOut:function(){this.viewer.viewport.zoomBy(1/this.viewer.zoomPerClick),this.viewer.viewport.applyConstraints()},updateImageShown:function(e){e.curtain.tiledImage&&e.curtain.tiledImage.setOpacity(e.shown?1:0)},updateClip:function(){var e,i,t,n,o=new OpenSeadragon.Point(this.viewer.container.clientWidth*this.clipFactorX,this.viewer.container.clientHeight*this.clipFactorY),a=this.viewer.viewport.pointFromPixel(o,!0),r=this.getShownImages();if(r.length>1&&(e=r[1].curtain.tiledImage)){i=e.getContentSize(),t=e.viewportToImageCoordinates(a);var s=Math.min(i.x,Math.max(0,t.x));n=new OpenSeadragon.Rect(s,0,i.x,i.y),e.setClip(n)}if(r.length>2&&(e=r[2].curtain.tiledImage)){i=e.getContentSize(),t=e.viewportToImageCoordinates(a);var c=Math.min(i.y,Math.max(0,t.y));n=new OpenSeadragon.Rect(0,c,i.x,i.y),e.setClip(n)}},dragClip:function(e,i,t){i&&(this.clipFactorX=e.x/this.viewer.container.clientWidth),t&&(this.clipFactorY=e.y/this.viewer.container.clientHeight),this.updateClip()},getShownImages:function(){return this.images.filter(function(e){return e.shown})}},OpenSeadragon.EventSource.prototype);var i=function(e){var i=this;this.images=e.images,this.startingZoom=e.zoom,this.startingPan=e.pan,this.leadingImage=null,OpenSeadragon.EventSource.call(this),this.innerContainer=document.createElement("div"),this.innerContainer.style.display="flex",this.innerContainer.style.height="100%",e.container.appendChild(this.innerContainer),this.images.forEach(function(t,n){t.sync={},t.sync.container=document.createElement("div"),t.sync.container.style.flexGrow=1,i.innerContainer.appendChild(t.sync.container),t.shown||(t.sync.container.style.display="none");var o=e.osdOptions;o.element=t.sync.container,o.tileSources=t.tileSource,t.sync.viewer=OpenSeadragon(o),t.sync.viewer.canvas.style.outline="none",t.sync.viewer.addHandler("open",function(){if(i.startingZoom&&t.sync.viewer.viewport.zoomTo(i.startingZoom,null,!0),i.startingPan)t.sync.viewer.viewport.panTo(i.startingPan,!0);else{var e=t.sync.viewer.world.getHomeBounds(),n=new OpenSeadragon.Point(e.x+e.width/2,e.y+e.height/2);t.sync.viewer.viewport.panTo(n,!0)}}),t.sync.viewer.addHandler("add-item-failed",function(e){i.raiseEvent("add-item-failed",e)});var a=function(){i.leadingImage&&i.leadingImage!==t||(i.leadingImage=t,i.images.forEach(function(e){e!==t&&(e.sync.viewer.viewport.zoomTo(t.sync.viewer.viewport.getZoom()),e.sync.viewer.viewport.panTo(t.sync.viewer.viewport.getCenter()))}),i.leadingImage=null)};t.sync.viewer.addHandler("zoom",function(){a()}),t.sync.viewer.addHandler("pan",function(){a()}),0===n&&t.sync.viewer.addHandler("viewport-change",function(){i.raiseEvent("change:viewport")})})};i.prototype=OpenSeadragon.extend({destroy:function(){this.images.forEach(function(e){e.sync.container.parentNode.removeChild(e.sync.container),e.sync.viewer.destroy(),delete e.sync}),this.innerContainer.parentNode.removeChild(this.innerContainer)},getZoom:function(){return this.images[0].sync.viewer.viewport.getZoom()},setZoom:function(e){this.images[0].sync.viewer.viewport.zoomTo(e,null,!0),this.startingZoom=e},getPan:function(){return this.images[0].sync.viewer.viewport.getCenter()},setPan:function(e){this.images[0].sync.viewer.viewport.panTo(e,!0),this.startingPan=e},zoomIn:function(){var e=this.images[0].sync.viewer;e.viewport.zoomBy(e.zoomPerClick),e.viewport.applyConstraints()},zoomOut:function(){var e=this.images[0].sync.viewer;e.viewport.zoomBy(1/e.zoomPerClick),e.viewport.applyConstraints()},updateImageShown:function(e){e.sync.container.style.display=e.shown?"block":"none"}},OpenSeadragon.EventSource.prototype),window.CurtainSyncViewer=function(e){var i=this;console.assert(e,"[CurtainSyncViewer] args is required"),console.assert(e.container,"[CurtainSyncViewer] args.container is required"),console.assert(e.images,"[CurtainSyncViewer] args.images is required"),console.assert(e.images.length>0,"[CurtainSyncViewer] args.images must have at least 1 image"),OpenSeadragon.EventSource.call(this),this.container=e.container,this.viewportEventThrottle=e.viewportEventThrottle||250,this.lastViewportEventTime=0,this.images=[],this.osdOptions=e.osdOptions||{},this.osdOptions.showNavigationControl=!1,"static"===getComputedStyle(this.container).position&&(this.container.style.position="relative"),e.images.forEach(function(e,t){console.assert(e.key,"[CurtainSyncViewer] args.images["+t+"].key is required"),console.assert(e.tileSource,"[CurtainSyncViewer] args.images["+t+"].tileSource is required");var n={key:e.key,tileSource:e.tileSource,shown:!!e.shown};i.images.push(n)}),this.setMode(e.mode||"curtain")},window.CurtainSyncViewer.prototype=OpenSeadragon.extend({getMode:function(){return this.modeKey},setMode:function(t){var n=this;if(console.assert("curtain"===t||"sync"===t,"[CurtainSyncViewer.setMode] Must have valid key."),t!==this.modeKey){this.mode&&this.mode.destroy(),this.modeKey=t;var o={container:this.container,images:this.images,zoom:this.zoom,pan:this.pan,osdOptions:OpenSeadragon.extend({},this.osdOptions)};this.mode="curtain"===t?new e(o):new i(o),this.mode.addHandler("change:viewport",function(){n.handleViewportChange()}),this.mode.addHandler("add-item-failed",function(e){n.raiseEvent("open-failed",{message:e.message||"",tileSource:e.options?e.options.tileSource:void 0})}),this.raiseEvent("change:mode")}},getZoom:function(){return this.mode.getZoom()},setZoom:function(e){console.assert("number"==typeof e&&e>0&&e<1/0,"[CurtainSyncViewer.setZoom] zoom must be a positive number"),this.mode.setZoom(e),this.handleViewportChange()},zoomIn:function(){this.mode.zoomIn(),this.handleViewportChange()},zoomOut:function(){this.mode.zoomOut(),this.handleViewportChange()},getPan:function(){return this.mode.getPan()},setPan:function(e){console.assert("object"==typeof e&&"number"==typeof e.x&&"number"==typeof e.y,"[CurtainSyncViewer.setPan] pan must be an object with an x and a y"),this.mode.setPan(new OpenSeadragon.Point(e.x,e.y)),this.handleViewportChange()},getImageShown:function(e){var i=!1;return this.images.forEach(function(t){t.key===e&&t.shown&&(i=!0)}),i},setImageShown:function(e,i){var t=this;i=!!i;var n=!1;this.images.forEach(function(o){o.key===e&&o.shown!==i&&(n=!0,o.shown=i,t.mode.updateImageShown(o))}),n&&this.raiseEvent("change:imageShown",{key:e})},handleViewportChange:function(){var e=this,i=this.getZoom(),t=this.getPan();if(!(this.zoom===i&&this.pan&&this.pan.x===t.x&&this.pan.y===t.y||this.viewportEventTimeout)){var n=Date.now(),o=n-this.lastViewportEventTime;o<this.viewportEventThrottle?this.viewportEventTimeout=setTimeout(function(){e.viewportEventTimeout=null,e.raiseEvent("change:viewport"),e.lastViewportEventTime=Date.now()},this.viewportEventThrottle-o):(this.raiseEvent("change:viewport"),this.lastViewportEventTime=n)}this.zoom=i,this.pan=t}},OpenSeadragon.EventSource.prototype)}();